---
title: "Example with Checkbox and Java Script Render"
output: 
  html_document:
    self_contained: false
    number_sections: true
    code_folding: hide
vignette: >
  %\VignetteIndexEntry{Example with Checkbox with JS}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE, 
  warning = FALSE
)
```

This vignette introduces the construction of interactive forest plot. 
We will generate several reactables with check boxes as Adverse Events (AE) filters. 
The AE filters considered in this vignette including 

- Serious AE: `adae$AESER`;
- Drug related AE: `adae$AEREL`;
- AE result in death: `adae$AESDTH`.

For example, 

- if you click `AESER`, then only the serious AEs will be displayed in the forest plot;
- if you click `AEREL`, then only the drug related AEs will be displayed in the forest plot, including PROBABLE/POSSIBLE/REMOTE drug related AEs;
- if you click `NONE`, then none filters applied to the AEs and all AEs will be displayed in the forest plot.


**Done:**

- _July 14:_
  
  - Applied `AESER`/`AEREL`/`NONE` filters to the forest plot to select serious/drug-related/all AEs.
  - Expedite the code by Java Script render.

- _July 28:_

  - Transform check box into a select list.
  - Impute `adae$ATOXGR`, `adae$AEACN` and `Grade3To5Flag`. 
  - Add `adae$AESDTH`,  `adae$adae$Grade3To5Flag` as the filter label.
  - Change the event-count to subject-count. See issue https://github.com/elong0527/forestly/issues/37 and `VISION BLURRED` is an example to check.
  - Add text labels for the error bar (Thanks Yilong)

**Discussion:**


**To Do List:**

  - Add some logic to not display error bar when ~0% vs. ~0%, but only show the difference. 
  - Encapsulate the long Rmd file into several functions for SP to validate.
  - ...

# Load Required Package 
```{r setup}
library(DescTools)      # Compare risk difference (Obtain confidence interval)
library(plotly)         # Interactive figure 
library(reactable)      # Interactive table 
library(dplyr)          
library(tidyr)
library(crosstalk)
library(htmltools)
devtools::load_all()
```


# Data Prepartion

## Impute data
In this section, we would like to 

- Impute `adae$ATOXGR`: if `adae$AESDTH='Y'` then `adae$ATOXGR='5'`, and random assign toxicity grade for other AE records;

```{r}
temp_fun <- function(x) {
    
  if(x == "Y"){
    return("5")
    }else{
    return(as.character(sample(1:4,size = 1, replace = TRUE)))
  }
}
adae <- adae %>% mutate(ATOXGR = unlist(adae$AESDTH %>% purrr:::map(temp_fun)))
```

- Generate `Grade3To5Flag` from `adae$ATOXGR`: `Grade3To5Flag` = "Y" if `adae$ATOXGR`>=3, otherwise `Grade3To5Flag` = "N". [create check box for 1,2,3,4,5? (Difficult to implement now, maybe left for future work).
```{r}
adae <- adae %>% mutate(Grade3To5Flag = ifelse(ATOXGR %in% c("3", "4", "5"), "Y", "N"))
```

- Impute `adae$AEACN`: `adae$AEACN` = `"DOSE NOT CHANGED"` or `"DRUG INTERRUPTED"` or `"DRUG WITHDRAWN"`. Here we impute 5% pts who discontinue drug (`DRUG WITHDRAWN`) and select the latest AE as `"DRUG WITHDRAWN"`.
```{r}
adae$AEACN = sample(c("DOSE NOT CHANGED", "DRUG INTERRUPTED", "DRUG WITHDRAWN"), 
                    size = length(adae$AEACN), prob = c(0.7, 0.25, 0.05), replace = TRUE)
```




## Define analysis data
```{r}
# tidy_ae_table is defined in R/ folder with same name 
# obtain AE information ready for visualization

db <- tidy_ae_table2(population_from  = adsl %>% rename(TRTA = TRT01A),
                     observation_from = adae,
                     population_where = NULL,
                     observation_where = NULL,
                     treatment_var = "TRTA",
                     treatment_order = c("MK9999" = "Xanomeline High Dose", "Placebo" = "Placebo"),
                     ae_var = "AEDECOD",
                     ae_interested = c("AESER", "AEREL", "Grade3To5Flag", "AEACN"),
                     listing_var = c("SITEID", "USUBJID", "RACE", "SEX", 
                                     "AETERM", "AESER", "AEREL", "AEACN", "AEOUT") )
```

## Calculate propotion test using M&N method
```{r}
# Calculate test using M&N method 
tb <- cbind(db$table,
            with(db$table, prop_test_mn(x0 = n_2, n0 = N_2, x1 = n_1, n1 = N_1))) 

tb$pct_1 = round(tb$pct_1, 2)
tb$pct_2 = round(tb$pct_2, 2)
tb$lower = round(tb$lower, 2)
tb$upper = round(tb$upper, 2)

t_display <- tb %>% mutate(fig_prop = NA, 
                           fig_diff = round(est, 2), 
                           ae = tools::toTitleCase(tolower(ae))) %>% 
                    select(ae, ae_label, stratum, 
                           fig_prop, fig_diff, 
                           lower, upper, 
                           n_1, pct_1, n_2, pct_2)
```

## Contruct the table containg all the details
```{r}
# Listing of subjects
# Require proper format for the header. 
t_detail <- db$listing
```

## Set the color of the two propotion in the forest plot
```{r}
color <- c("gold", "purple")
```

# Construct Interactive Froest Plot

## Define auxilliary functions for the interactive plot
```{r}
# function to create proportion of subjects figure
js_fig_prop_cell <- sparkline_point_js2(tbl = t_display,
                                        x = c("pct_1","pct_2"),
                                        y = c(1, 1),
                                        xlim = round(range(c(tb$pct_1, tb$pct_2)) + c(-0.51, 0.51) ),
                                        color = color,
                                        height = 30,
                                        text = c("x[0]", "x[1]"))

# function to create Axis 
fig_prop_footer <- function(value){
  
  tmp <- tb[1, ] %>% pivot_longer(cols = starts_with("pct"))
  xlim <- round(range(c(tb$pct_1, tb$pct_2)) + c(-0.51, 0.51) )
  sparkline_draw_axis(color = color, 
                      label = levels(db$listing$treatment), 
                      xlim = xlim)
}

# function to create proportion difference figure
js_fig_diff_cell <- sparkline_point_js2(tbl = t_display, 
                                        x = "fig_diff", 
                                        x_lower = "lower", 
                                        x_upper = "upper",
                                        xlim = round(range(c(tb$lower, tb$upper)) + c(-0.51, 0.51)),
                                        text = "'range:' + x + '(' + x_lower + ',' + x_upper + ')'",
                                        color = "black")

# function to create Axis 
fig_diff_footer <- function(value){
  
  tmp <- tb[1, ] %>% pivot_longer(cols = starts_with("pct"))
  xlim = round(range(c(tb$lower, tb$upper)) + c(-0.51, 0.51))
  sparkline_draw_axis(showlegend = FALSE, 
                      xlab = "MK9999 <- Favor -> Placebo", 
                      color = "black",
                      xlim = xlim, height = 30, margin_bottom = 50)
}


```

## Make the data frame eligible for check box design
```{r}
t_display1 <- SharedData$new(t_display)
```

```{r}
Sys.time()
```

## Plot the interative forest plot
```{r, message=FALSE}
h3("Filter by:")

tagList(
  crosstalk::filter_select("filter_AEcategory", "AE filters", t_display1, ~ae_label, multiple = FALSE),
  br()
)

# mk_reactable saved in the R/ folder: define default behavior of reactable. 
p <- mk_reactable(
  t_display1,
  
  # reactable configuration https://glin.github.io/reactable/reference/reactable.html
  resizable = TRUE, 
  filterable = TRUE,
  searchable = TRUE, 
  defaultPageSize = 10, 
  borderless = TRUE, 
  striped = TRUE, 
  highlight = TRUE, 
  
  # No padding between two cells (ensure no break line between reference line)
  theme = reactableTheme(cellPadding = "0px 8px"),
  
  # Default sort variable 
  defaultSorted = c("ae_label", "fig_diff"),
  defaultSortOrder = c("desc", "asc"),
  
  # Define listing of subjects
  details = function(index){
    t_row <- t_display[index, ]
    subset(t_detail, toupper(ae) %in% toupper(t_row$ae)) %>% mk_reactable
  },
  
  # Customize cell feature 
  columnGroups = list(
    colGroup(name = "MK9999 (N = 84)",  columns = c("n_1", "pct_1")),
    colGroup(name = "Placebo (N = 86)", columns = c("n_2", "pct_2"))
  ),
  # 
  columns = list(
    ae = colDef(header = "Adverse Events", minWidth = 300, align = "right"),

    stratum = colDef(header = "Stratum", show = FALSE),
    
    ae_label = colDef(header = "Label"),

    fig_prop = colDef(header = "AE Proportion (%)",
                      minWidth = 300, align = "center",
                      cell = JS(js_fig_prop_cell), 
                      footer = fig_prop_footer,
                      html = TRUE),

    fig_diff = colDef(header = "Risk Diff (%) + 95% CI",
                      defaultSortOrder = "desc",
                      minWidth = 200, align = "center",
                      cell = JS(js_fig_diff_cell),
                      footer = fig_diff_footer,
                      html = TRUE,
                      style="font-size: 0px; padding: 0px; margin: 0px;"),

    n_1 = colDef(header = "n", defaultSortOrder = "desc", width = 60, align = "center"),
    n_2 = colDef(header = "n", defaultSortOrder = "desc", width = 60, align = "center"),
    
    pct_1 = colDef(header = "(%)", defaultSortOrder = "desc", width = 80, 
                   align = "center", format = colFormat(digits = 2) ),
    pct_2 = colDef(header = "(%)", defaultSortOrder = "desc", width = 80, 
                   align = "center", format = colFormat(digits = 2) ),
    
    lower = colDef(header = "lower CI", show = FALSE),
    upper = colDef(header = "upper CI", show = FALSE)
  )

)

plotly_js <- "https://unpkg.com/react-plotly.js@1.0.2/dist/create-plotly-component.js"
browsable(tagList(
  reactR::html_dependency_react(),
  htmltools::tags$script(src="https://cdn.plot.ly/plotly-latest.min.js"),
  htmltools::tags$script(src=plotly_js),
  p
))
```



```{r}
Sys.time()
```





